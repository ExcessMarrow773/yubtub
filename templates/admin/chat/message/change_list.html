{% extends "admin/change_list.html" %}
{% load admin_urls %}

{% block result_list %}
<form method="post" action="">
  {% csrf_token %}

  <div class="actions">
    {% if action_form %}
      <label for="action">Action:</label>
      {{ action_form.action }}
      <input type="submit" value="Go">
    {% endif %}
  </div>

  {% if conversations %}
    {% for key, messages in conversations %}
      {% with from_user=key.0 to_user=key.1 %}
      <div class="conversation-block">
        <h3 class="conversation-header" style="cursor:pointer;">
          {{ from_user }} ↔ {{ to_user }} ({{ messages|length }} message{{ messages|length|pluralize }})
        </h3>
        <div class="conversation-messages" style="display:none; margin-bottom: 1em;">
            {% for msg in messages %}
                <label style="display:flex; align-items:center; gap:6px;">
                  <input type="checkbox" name="_selected_action" value="{{ msg.pk }}">
                  <strong>{{ msg.sent_on }}
                  <a href="{% url opts|admin_urlname:'change' msg.pk %}">
                    | From: {{ msg.from_user.username }}</strong> – {{ msg.body|truncatechars:80 }}
                  </a>
                </label>
            {% endfor %}
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  {% else %}
    <p>No messages found.</p>
  {% endif %}
</form>

<script>
document.querySelectorAll('.conversation-header').forEach(header => {
  header.addEventListener('click', () => {
    const content = header.nextElementSibling;
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
  });
});
</script>
{% endblock %}
